{% extends "base.html" %}

{% block title %}WhatsApp Web Clone{% endblock %}

{% block content %}
<style>
    body, html { margin: 0; padding: 0; font-family: Segoe UI,Helvetica Neue,Helvetica,Lucida Grande,Arial,Ubuntu,Cantarell,Fira Sans,sans-serif; height: 100%; }
    body.dark-mode { background-color: #111b21; color: #e9edef; }
    .container { display: flex; height: 100vh; background-color: #f0f2f5; }
    body.dark-mode .container { background-color: #111b21; }
    .sidebar { width: 30%; background-color: #ffffff; border-right: 1px solid #d1d7db; display: flex; flex-direction: column; }
    body.dark-mode .sidebar { background-color: #111b21; border-right-color: #2a3942; }
    .sidebar-header { background-color: #f0f2f5; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
    body.dark-mode .sidebar-header { background-color: #202c33; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #ddd; }
    .search-bar { padding: 10px; }
    .search-bar input { width: 100%; padding: 8px; border-radius: 8px; border: none; background-color: #f0f2f5; }
    body.dark-mode .search-bar input { background-color: #202c33; color: #e9edef; }
    #contact-list { flex-grow: 1; overflow-y: auto; }
    .contact { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f0f2f5; cursor: pointer; }
    body.dark-mode .contact { border-bottom-color: #2a3942; }
    .contact:hover { background-color: #f5f5f5; }
    body.dark-mode .contact:hover { background-color: #2a3942; }
    .contact.active { background-color: #e9edef; }
    body.dark-mode .contact.active { background-color: #2a3942; }
    .contact-avatar { width: 49px; height: 49px; border-radius: 50%; background-color: #ddd; margin-right: 15px; }
    .contact-info { flex-grow: 1; }
    .contact-name { font-weight: bold; }
    .contact-tag { font-size: 0.8em; color: #667781; }
    body.dark-mode .contact-tag { color: #8696a0; }
    .main-chat { flex: 1; display: flex; flex-direction: column; background-color: #efeae2; }
    body.dark-mode .main-chat { background-color: #0b141a; }
    .chat-header { background-color: #f0f2f5; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #d1d7db; }
    body.dark-mode .chat-header { background-color: #202c33; border-bottom-color: #2a3942; }
    #chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
    .message { max-width: 65%; padding: 8px; border-radius: 7.5px; margin-bottom: 10px; }
    .message-sent { align-self: flex-end; background-color: #d9fdd3; }
    body.dark-mode .message-sent { background-color: #005c4b; }
    .message-received { align-self: flex-start; background-color: white; }
    body.dark-mode .message-received { background-color: #202c33; }
    .message-content { margin-bottom: 5px; }
    .message-time { font-size: 0.75em; color: #667781; text-align: right; }
    body.dark-mode .message-time { color: #8696a0; }
    .chat-input { background-color: #f0f2f5; padding: 10px; display: flex; align-items: center; }
    body.dark-mode .chat-input { background-color: #202c33; }
    #message-input { flex: 1; padding: 9px 12px; border-radius: 8px; border: none; background-color: #ffffff; }
    body.dark-mode #message-input { background-color: #2a3942; color: #e9edef; }
    .send-button { margin-left: 10px; padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 50%; cursor: pointer; }
    .button { cursor: pointer; padding: 5px; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; }
    body.dark-mode .dropdown-content { background-color: #2a3942; }
    .dropdown-content a { color: black; padding: 12px 16px; text-decoration: none; display: block; }
    body.dark-mode .dropdown-content a { color: #e9edef; }
    .dropdown-content a:hover { background-color: #f1f1f1; }
    body.dark-mode .dropdown-content a:hover { background-color: #111b21; }
    .show { display: block; }
    #search-input { display: none; width: 100%; }
    .tag-button { background-color: #00a884; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 14px; line-height: 20px; text-align: center; cursor: pointer; margin-left: 10px; padding: 0; }
    .tag-modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .tag-modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 300px; border-radius: 8px; }
    body.dark-mode .tag-modal-content { background-color: #2a3942; border-color: #8696a0; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    body.dark-mode .close { color: #8696a0; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    body.dark-mode .close:hover, body.dark-mode .close:focus { color: #e9edef; }
    #tagInput { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; }
    body.dark-mode #tagInput { background-color: #111b21; color: #e9edef; border: 1px solid #8696a0; }
    #addTagButton { background-color: #00a884; color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 8px; }
    body.dark-mode #addTagButton { background-color: #00a884; }

    .tag-sidebar {
        position: fixed;
        right: -300px;
        top: 0;
        width: 300px;
        height: 100%;
        background-color: #f0f2f5;
        transition: right 0.3s ease-in-out;
        padding: 20px;
        box-sizing: border-box;
    }
    body.dark-mode .tag-sidebar {
        background-color: #2a3942;
    }
    .tag-sidebar.open {
        right: 0;
    }
    .tag-sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .close-sidebar {
        cursor: pointer;
        font-size: 24px;
    }
    #tagList {
        margin-top: 20px;
    }
    .tag-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
    }
    .delete-tag {
        cursor: pointer;
        color: red;
    }

    .tag-dropdown {
        margin-right: 10px;
    }
    #tagSelect, #addNoteBtn {
        padding: 5px;
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .note {
        background-color: #ffffd0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
    }

    body.dark-mode .modal-content {
        background-color: #2a3942;
        color: #e9edef;
    }

    body.dark-mode .note {
        background-color: #3b4a54;
        color: #e9edef;
    }

    .message-status { margin-left: 5px; }
    .status-sending:after { content: "üïí"; }
    .status-sent:after { content: "‚úì"; }
    .status-delivered:after { content: "‚úì‚úì"; }
    .status-read:after { content: "‚úì‚úì"; color: #4fc3f7; }
    .status-failed:after { content: "‚ùå"; color: red; }
    .tag { background-color: #e1f3fb; padding: 5px; border-radius: 5px; margin-bottom: 10px; }
    body.dark-mode .tag { background-color: #1e2a30; }
    #contactNote { width: 100%; margin-bottom: 10px; }
    #saveNoteBtn { width: 100%; }

    /* Responsive layout */
    @media (max-width: 768px) {
        .container {
            flex-direction: column;
        }
        .sidebar {
            width: 100%;
            height: 30vh;
        }
        .main-chat {
            height: 70vh;
        }
    }

    /* Improve button styles */
    .button {
        cursor: pointer;
        padding: 8px 12px;
        background-color: #25D366;
        color: white;
        border: none;
        border-radius: 4px;
        margin: 0 5px;
    }
    .button:hover {
        background-color: #128C7E;
    }
</style>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="avatar"></div>
            <div>
                <button class="button" id="dark-mode-toggle">üåô</button>
                <button class="button" id="search-toggle">üîç</button>
                <button class="button" id="add-contact">‚ûï</button>
                <div class="dropdown">
                    <button class="button" id="menu-toggle">‚ãÆ</button>
                    <div class="dropdown-content" id="dropdown-menu">
                        <a href="{{ url_for('home') }}">Home</a>
                        <a href="{{ url_for('send_message_page') }}">Send Message</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Search or start new chat">
        </div>
        <div id="contact-list"></div>
    </div>
    <div class="main-chat">
        <div class="chat-header">
            <div id="current-contact">Select a contact</div>
            <div class="tag-dropdown">
                <select id="tagSelect">
                    <option value="">Select Tag</option>
                    <option value="ƒ∞lk_mesaj">ƒ∞lk mesaj</option>
                    <option value="cevaplandƒ±">Cevaplandƒ±</option>
                    <option value="photoshop bekliyor">Photoshop bekliyor</option>
                    <option value="teslim bekliyor">Teslim bekliyor</option>
                    <option value="teslim edildi">Teslim edildi</option>
                </select>
            </div>
            <button id="addNoteBtn">Add Note</button>
        </div>
        <div id="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="message-input" placeholder="Type a message">
            <button class="send-button" onclick="sendMessage()">‚û§</button>
        </div>
    </div>
</div>

<div id="tagModal" class="tag-modal">
    <div class="tag-modal-content">
        <span class="close">&times;</span>
        <h2>Add Tag</h2>
        <input type="text" id="tagInput" placeholder="Enter tag">
        <button id="addTagButton" onclick="addTag()">Add</button>
    </div>
</div>

<div class="tag-sidebar" id="tagSidebar">
    <div class="tag-sidebar-header">
        <h3>Contact Info</h3>
        <span class="close-sidebar">&times;</span>
    </div>
    <div class="tag-sidebar-content">
        <div class="contact-info-section">
            <h4>Tags</h4>
            <select id="tagSelect">
                <option value="">Select Tag</option>
                <option value="ƒ∞lk_mesaj">ƒ∞lk mesaj</option>
                <option value="cevaplandƒ±">Cevaplandƒ±</option>
                <option value="photoshop bekliyor">Photoshop bekliyor</option>
                <option value="teslim bekliyor">Teslim bekliyor</option>
                <option value="teslim edildi">Teslim edildi</option>
            </select>
            <button id="addCustomTagBtn">Add Custom Tag</button>
            <div id="customTagInput" style="display: none;">
                <input type="text" id="newTagInput" placeholder="Enter new tag">
                <button id="saveNewTagBtn">Save</button>
            </div>
            <div id="contactTags"></div>
        </div>
        <div class="contact-info-section">
            <h4>Notes</h4>
            <textarea id="contactNote" rows="4" placeholder="Add a note"></textarea>
            <button id="saveNoteBtn">Save Note</button>
        </div>
    </div>
</div>

<div id="noteModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <textarea id="noteText" rows="4" cols="50"></textarea>
        <button id="saveNoteBtn">Save Note</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const BUSINESS_PHONE_NUMBER_ID = "{{ business_phone_number_id }}";
    let currentContact = null;
    let socket = new WebSocket("wss://" + window.location.host + "/ws");
    let conversations = {};

    function loadConversations() {
        const savedConversations = localStorage.getItem('conversations');
        if (savedConversations) {
            conversations = JSON.parse(savedConversations);
            console.log("Loaded conversations:", conversations);
        }
    }

    function saveConversations() {
        localStorage.setItem('conversations', JSON.stringify(conversations));
        console.log("Saved conversations:", conversations);
    }

    socket.onopen = function(e) {
        console.log("WebSocket connection established");
        loadContacts();
        loadConversations();
    };

    socket.onmessage = function(event) {
        console.log("WebSocket message received:", event.data);
        const data = JSON.parse(event.data);
        if (data.type === "new_message") {
            const message = data.message;
            if (!conversations[message.from]) {
                conversations[message.from] = [];
            }
            conversations[message.from].push(message);
            updateContactList(message);
            if (message.from === currentContact || message.to === currentContact) {
                addMessageToChat(message);
            }
            saveConversations();
        } else if (data.type === "status_update") {
            updateMessageStatus(data.status);
        }
    };

    socket.onerror = function(error) {
        console.error(`WebSocket Error: ${error}`);
    };

    socket.onclose = function(event) {
        if (event.wasClean) {
            console.log(`WebSocket connection closed cleanly, code=${event.code}, reason=${event.reason}`);
        } else {
            console.error('WebSocket connection died');
        }
        // Attempt to reconnect
        setTimeout(function() {
            socket = new WebSocket("wss://" + window.location.host + "/ws");
        }, 5000);
    };

    function loadContacts() {
        console.log("Loading contacts...");
        $.get('/get_contacts', function(contacts) {
            console.log("Contacts received:", contacts);
            $('#contact-list').empty();
            if (contacts.length === 0) {
                $('#contact-list').append('<div>No contacts available</div>');
            } else {
                contacts.forEach(function(contact) {
                    addContactToList(contact);
                });
            }
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error("Error loading contacts:", textStatus, errorThrown);
            $('#contact-list').append('<div>Error loading contacts</div>');
        });
    }

    function addContactToList(contact) {
        const contactElement = $(`
            <div class="contact" data-number="${contact.number}">
                <div class="contact-info" onclick="selectContact('${contact.number}')">
                    <div class="contact-avatar"></div>
                    <div class="contact-details">
                        <div class="contact-name">${contact.name || contact.number}</div>
                        <div class="contact-last-message"></div>
                    </div>
                </div>
                <button class="tag-button" onclick="openTagSidebar('${contact.number}')">+</button>
            </div>
        `);
        $('#contact-list').append(contactElement);
    }

    function selectContact(contact) {
        currentContact = contact;
        $('#current-contact').text(contact);
        updateChat();
    }

    function updateContactList(message) {
        const contact = message.from === BUSINESS_PHONE_NUMBER_ID ? message.to : message.from;
        let contactElement = $(`.contact[data-number="${contact}"]`);
        if (contactElement.length) {
            contactElement.find('.contact-last-message').text(message.text);
            contactElement.prependTo('#contact-list');
        } else {
            addContactToList({number: contact, name: contact});
            contactElement = $(`.contact[data-number="${contact}"]`);
        }
        contactElement.find('.contact-last-message').text(message.text);
    }

    function addMessageToChat(message) {
        const isReceived = message.from !== BUSINESS_PHONE_NUMBER_ID;
        const messageElement = $(`
            <div class="message ${isReceived ? 'message-received' : 'message-sent'}" data-message-id="${message.id}">
                <div class="message-content">${message.text}</div>
                <div class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</div>
                <div class="message-status status-${message.status}"></div>
            </div>
        `);
        $('#chat-messages').append(messageElement);
        $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
    }

    function updateChat() {
        if (!currentContact) return;
        $('#chat-messages').empty();
        if (conversations[currentContact]) {
            conversations[currentContact].forEach(addMessageToChat);
        }
        $.get(`/get_messages/${currentContact}`, function(data) {
            data.messages.forEach(function(msg) {
                if (!conversations[currentContact]) {
                    conversations[currentContact] = [];
                }
                if (!conversations[currentContact].some(m => m.id === msg.id)) {
                    conversations[currentContact].push(msg);
                    addMessageToChat(msg);
                }
            });
            saveConversations();
        });
    }

    function sendMessage() {
        if (!currentContact) {
            alert('Please select a contact first');
            return;
        }
        const message = $('#message-input').val();
        if (message.trim() === '') return;

        $.post('/send_message', {to: currentContact, message: message}, function(response) {
            if (response.success) {
                const newMessage = {
                    id: response.message_id,
                    from: BUSINESS_PHONE_NUMBER_ID,
                    to: currentContact,
                    text: message,
                    timestamp: new Date().toISOString(),
                    status: 'sent'
                };
                if (!conversations[currentContact]) {
                    conversations[currentContact] = [];
                }
                conversations[currentContact].push(newMessage);
                addMessageToChat(newMessage);
                $('#message-input').val('');
                updateContactList(newMessage);
                saveConversations();
            } else {
                console.error('Failed to send message:', response.error);
            }
        });
    }

    function updateMessageStatus(status) {
        console.log("Message status update:", status);
        if (conversations[currentContact]) {
            const message = conversations[currentContact].find(m => m.id === status.id);
            if (message) {
                message.status = status.status;
                const messageElement = $(`.message[data-message-id="${status.id}"]`);
                if (messageElement.length) {
                    const statusElement = messageElement.find('.message-status');
                    if (statusElement.length) {
                        statusElement.removeClass().addClass(`message-status status-${status.status.toLowerCase()}`);
                    }
                }
                saveConversations();
            }
        }
    }

    function addNewContact() {
        const number = prompt("Enter contact number:");
        const name = prompt("Enter contact name:");
        if (number && name) {
            $.post('/add_contact', { number: number, name: name }, function(response) {
                if (response.success) {
                    addContactToList(response.contact);
                    alert("Contact added successfully");
                } else {
                    alert("Failed to add contact");
                }
            }).fail(function() {
                alert("Error adding contact");
            });
        }
    }

    $('#message-input').keypress(function(e) {
        if(e.which == 13) {
            sendMessage();
        }
    });

    // Initialize UI elements
    $(document).ready(function() {
        loadConversations();
        loadContacts();

        $('#dark-mode-toggle').click(function() {
            $('body').toggleClass('dark-mode');
        });

        $('#search-toggle').click(function() {
            $('#search-input').toggle();
        });

        $('#menu-toggle').click(function() {
            $('#dropdown-menu').toggleClass('show');
        });

        $('#addNoteBtn').click(function() {
            $('#noteModal').show();
        });

        $('.close').click(function() {
            $('.modal').hide();
        });

        $('#saveNoteBtn').click(function() {
            // Implement note saving logic here
            $('.modal').hide();
        });

        $('#add-contact').click(addNewContact);
    });

    // Add an event listener for when the page is about to unload
    window.addEventListener('beforeunload', saveConversations);
</script>
{% endblock %}